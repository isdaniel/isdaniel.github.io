<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"isdaniel.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="å‰è¨€åŸ·è¡Œè¨ˆç•«ä»£è¡¨æ­¤æ¬¡æŸ¥è©¢è¦æ€éº¼æ¨£çš„æ¼”ç®—æ³•æŸ¥è©¢æˆ‘å€‘çš„è³‡æ–™ï¼Œè€Œæˆæœ¬æ˜¯æ±ºå®šä½¿ç”¨å“ªå€‹åŸ·è¡Œè¨ˆç•«çš„é‡è¦å› ç´  åœ¨ postgreSQL DB query optimizer æœƒé¸æ“‡æˆæœ¬æœ€ä½çš„åŸ·è¡Œè¨ˆåŠƒï¼Œç•¶ä½œæŸ¥è©¢è³‡æ–™ä½¿ç”¨ç®—æ³• åœ¨ Sql-sevrer æˆæœ¬è¨ˆç®—å°è£åœ¨ç¨‹å¼å…§éƒ¨ï¼Œæˆ‘å€‘ç„¡æ³•é€éä¸€äº›å› å­ä¾†èª¿æ•´ï¼Œä½† postgreSQL å¯ä»¥ æˆ‘èªç‚º query optimizer åˆ¤æ–·æˆæœ¬æ¦‚å¿µæœ‰é»é¡ä¼¼ google map">
<meta property="og:type" content="article">
<meta property="og:title" content="postgresql åŸ·è¡Œè¨ˆç•«é‡è¦å› å­ (æˆæœ¬å› å­èª¿æ•™)">
<meta property="og:url" content="https://isdaniel.github.io/postgresql-cost-factor-tuning/index.html">
<meta property="og:site_name" content="çŸ³é ­çš„codingä¹‹è·¯">
<meta property="og:description" content="å‰è¨€åŸ·è¡Œè¨ˆç•«ä»£è¡¨æ­¤æ¬¡æŸ¥è©¢è¦æ€éº¼æ¨£çš„æ¼”ç®—æ³•æŸ¥è©¢æˆ‘å€‘çš„è³‡æ–™ï¼Œè€Œæˆæœ¬æ˜¯æ±ºå®šä½¿ç”¨å“ªå€‹åŸ·è¡Œè¨ˆç•«çš„é‡è¦å› ç´  åœ¨ postgreSQL DB query optimizer æœƒé¸æ“‡æˆæœ¬æœ€ä½çš„åŸ·è¡Œè¨ˆåŠƒï¼Œç•¶ä½œæŸ¥è©¢è³‡æ–™ä½¿ç”¨ç®—æ³• åœ¨ Sql-sevrer æˆæœ¬è¨ˆç®—å°è£åœ¨ç¨‹å¼å…§éƒ¨ï¼Œæˆ‘å€‘ç„¡æ³•é€éä¸€äº›å› å­ä¾†èª¿æ•´ï¼Œä½† postgreSQL å¯ä»¥ æˆ‘èªç‚º query optimizer åˆ¤æ–·æˆæœ¬æ¦‚å¿µæœ‰é»é¡ä¼¼ google map">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/ZAs54l8.png">
<meta property="article:published_time" content="2021-10-17T20:30:11.000Z">
<meta property="article:modified_time" content="2025-08-10T03:23:11.059Z">
<meta property="article:author" content="Daniel Shih">
<meta property="article:tag" content="DataBase">
<meta property="article:tag" content="Turning">
<meta property="article:tag" content="postgresql">
<meta property="article:tag" content="cost">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/ZAs54l8.png">

<link rel="canonical" href="https://isdaniel.github.io/postgresql-cost-factor-tuning/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>postgresql åŸ·è¡Œè¨ˆç•«é‡è¦å› å­ (æˆæœ¬å› å­èª¿æ•™) | çŸ³é ­çš„codingä¹‹è·¯</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9964202165342528"
     crossorigin="anonymous"></script>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZKF58CMZ8X"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-ZKF58CMZ8X');
  </script>
  <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
  </script>
  <meta name="google-adsense-account" content="ca-pub-9964202165342528">

  <style>
    /* Full-screen overlay */
    #adblock-overlay {
      display: none;
      position: fixed;
      z-index: 9999;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.85);
      color: #fff;
      font-family: sans-serif;
      text-align: center;
      padding-top: 20%;
    }

    #adblock-overlay h1 {
      font-size: 2em;
      margin-bottom: 20px;
    }

    #adblock-overlay p {
      font-size: 1.2em;
    }
  </style>
  <script>
    /*document.addEventListener("DOMContentLoaded", function () {
      const overlay = document.getElementById("adblock-overlay");

      const adScript = document.createElement("script");
      adScript.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9964202165342528";
      adScript.async = true;
      adScript.crossOrigin = "anonymous";

      adScript.onerror = function () {
        console.warn("Adblock detected â€” showing full-page overlay.");
        overlay.style.display = "block";
        document.body.style.overflow = "hidden"; // prevent scroll
      };

      document.head.appendChild(adScript);
    });*/
  </script>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  
  <div id="adblock-overlay">
    <h1>ğŸš« Ad Blocker Detected</h1>
    <p>Please disable your AD blocker to continue using this site. Ads help us keep the content free! please press keyboard F5 to refresh page after disabled AD blocker</p>
    <p>è«‹é—œé–‰å»£å‘Šæ””æˆªå™¨ä»¥ç¹¼çºŒä½¿ç”¨æœ¬ç¶²ç«™ã€‚å»£å‘Šæœ‰åŠ©æ–¼æˆ‘å€‘ä¿è­‰å…§å®¹å…è²»ã€‚è¬è¬! é—œé–‰å¾Œè«‹æŒ‰ F5 åˆ·æ–°é é¢</p>
  </div>
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">çŸ³é ­çš„codingä¹‹è·¯</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Hello World</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-course">

    <a href="/Course/" rel="section"><i class="fa fa-fw fa-book"></i>Course</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">136</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">65</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">186</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://isdaniel.github.io/postgresql-cost-factor-tuning/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/9159452?s=460&v=4">
      <meta itemprop="name" content="Daniel Shih">
      <meta itemprop="description" content="å¥½é»å­æ²’åƒ¹å€¼ï¼Œæœ‰åƒ¹å€¼çš„æ˜¯æŠŠå¥½é»å­å¯¦ç¾">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="çŸ³é ­çš„codingä¹‹è·¯">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          postgresql åŸ·è¡Œè¨ˆç•«é‡è¦å› å­ (æˆæœ¬å› å­èª¿æ•™)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-17 20:30:11" itemprop="dateCreated datePublished" datetime="2021-10-17T20:30:11+00:00">2021-10-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-08-10 03:23:11" itemprop="dateModified" datetime="2025-08-10T03:23:11+00:00">2025-08-10</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Turning/" itemprop="url" rel="index"><span itemprop="name">Turning</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Turning/postgresql/" itemprop="url" rel="index"><span itemprop="name">postgresql</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/postgresql-cost-factor-tuning/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="postgresql-cost-factor-tuning/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>17 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <div itemscope itemtype="http://schema.org/ImageGallery">
            <img src="https://i.imgur.com/ZAs54l8.png" itemprop="contentUrl">
        </div>
        <h2 id="å‰è¨€"><a href="#å‰è¨€" class="headerlink" title="å‰è¨€"></a>å‰è¨€</h2><p>åŸ·è¡Œè¨ˆç•«ä»£è¡¨æ­¤æ¬¡æŸ¥è©¢è¦æ€éº¼æ¨£çš„æ¼”ç®—æ³•æŸ¥è©¢æˆ‘å€‘çš„è³‡æ–™ï¼Œè€Œ<strong>æˆæœ¬</strong>æ˜¯æ±ºå®šä½¿ç”¨å“ªå€‹åŸ·è¡Œè¨ˆç•«çš„é‡è¦å› ç´ </p>
<p>åœ¨ postgreSQL DB query optimizer æœƒé¸æ“‡æˆæœ¬æœ€ä½çš„åŸ·è¡Œè¨ˆåŠƒï¼Œç•¶ä½œæŸ¥è©¢è³‡æ–™ä½¿ç”¨ç®—æ³•</p>
<p>åœ¨ Sql-sevrer æˆæœ¬è¨ˆç®—å°è£åœ¨ç¨‹å¼å…§éƒ¨ï¼Œæˆ‘å€‘ç„¡æ³•é€éä¸€äº›å› å­ä¾†èª¿æ•´ï¼Œä½† postgreSQL å¯ä»¥</p>
<p>æˆ‘èªç‚º query optimizer åˆ¤æ–·æˆæœ¬æ¦‚å¿µæœ‰é»é¡ä¼¼ google map åœ¨æ‰¾å°‹æœ€ä½³è·¯å¾‘</p>
<blockquote>
<p>æˆ‘å°æ–¼è³‡æ–™åº«æœ‰å®šç¾©ä¸€å€‹ï¼Œ<strong>åœ°åœ–ç†è«–</strong>ä¾†èªªæ˜ RDBMS åŸ·è¡Œè¨ˆç•«ç›¸é—œçš„äº‹æƒ…</p>
</blockquote>
<p>æœ¬ç¯‡æˆæœ¬å› å­æ•ˆèƒ½èª¿æ•™æœƒæ¶‰ Linux kernel systemtap ï¼Œåœ‹ä¸­æ•¸å­¸ï¼ŒpostgreSQL é‹ä½œæ¨¡å‹ï¼Œç¯‡å¹…å¯èƒ½æœƒæœ‰é»å¤šä¸”è¤‡é›œ</p>
<p>ä½†æˆ‘èªç‚ºæœ¬ç¯‡å­¸æœƒå¯ä»¥å°æ–¼ã€€query optimizer æœ‰æ›´é€²ä¸€æ­¥äº†è§£</p>
<h2 id="é è¨­æˆæœ¬å› å­æ½›åœ¨å•é¡Œ"><a href="#é è¨­æˆæœ¬å› å­æ½›åœ¨å•é¡Œ" class="headerlink" title="é è¨­æˆæœ¬å› å­æ½›åœ¨å•é¡Œ"></a>é è¨­æˆæœ¬å› å­æ½›åœ¨å•é¡Œ</h2><p>ä¸‹é¢æˆ‘ä½¿ç”¨ä¸€å€‹ä¾‹å­ä¾†</p>
<p>æˆ‘å€‘åˆ©ç”¨ä¸€æ¨£çš„æŸ¥è©¢ explain (analyze,verbose,costs,buffers,timing) select id from tbl where id &gt; 70000;</p>
<p>æŸ¥çœ‹ä½¿ç”¨ <code>table scan</code> &amp; <code>index scan only</code> åŸ·è¡Œè¨ˆç•«é ä¼°å€¼è·Ÿå¯¦éš›æŸ¥è©¢å·®ç•°.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">postgres=# explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> info from tbl <span class="built_in">where</span> info =<span class="string">&#x27;girl&#x27;</span>;</span><br><span class="line">                                                    QUERY PLAN                                                     </span><br><span class="line">-------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Seq Scan on public.tbl  (cost=0.00..5456.48 rows=300016 width=4) (actual <span class="keyword">time</span>=0.013..216.970 rows=299999 loops=1)</span><br><span class="line">   Output: info</span><br><span class="line">   Filter: (tbl.info = <span class="string">&#x27;girl&#x27;</span>::text)</span><br><span class="line">   Rows Removed by Filter: 4999</span><br><span class="line">   Buffers: shared hit=1644</span><br><span class="line"> Planning Time: 0.067 ms</span><br><span class="line"> Execution Time: 404.836 ms</span><br><span class="line">(7 rows)</span><br><span class="line"></span><br><span class="line">postgres=# </span><br><span class="line">SET</span><br><span class="line">postgres=# <span class="built_in">set</span> enable_seqscan=off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> info from tbl <span class="built_in">where</span> info =<span class="string">&#x27;girl&#x27;</span>;</span><br><span class="line">                                                              QUERY PLAN                                                               </span><br><span class="line">---------------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Index Only Scan using tbl_ix on public.tbl  (cost=0.30..6202.58 rows=300016 width=4) (actual <span class="keyword">time</span>=0.025..196.965 rows=299999 loops=1)</span><br><span class="line">   Output: info</span><br><span class="line">   Index Cond: (tbl.info = <span class="string">&#x27;girl&#x27;</span>::text)</span><br><span class="line">   Heap Fetches: 0</span><br><span class="line">   Buffers: shared hit=237</span><br><span class="line"> Planning Time: 0.067 ms</span><br><span class="line"> Execution Time: 377.856 ms</span><br><span class="line">(7 rows)</span><br></pre></td></tr></table></figure>

<p>ç™¼ç¾æ˜æ˜æŸ¥è©¢èªæ³•éƒ½ä¸€æ¨£ï¼Œåªæ˜¯é€é Setting ç™¼ç¾æ˜æ˜æ˜¯ <code>Index Only Scan</code> åŸ·è¡Œå¯¦éš›æ™‚é–“æˆæœ¬æ¯”è¼ƒä½ï¼Œä½† query optimizer å»é¸æ“‡ table scanï¼Œæœƒé€ æˆä¸Šé¢å•é¡Œæ˜¯å› ç‚ºæˆæœ¬å› å­æ²’æœ‰èª¿æ•™æ‰€é€ æˆ</p>
<blockquote>
<p>é€™ä¹Ÿæ˜¯æˆ‘ä¸€é–‹å§‹èªªæˆæœ¬å› å­çš„é‡è¦æ€§</p>
</blockquote>
<p>å¦å¤–ä¸Šé¢ cost ä»£è¡¨å«æ„ä¹Ÿä¸æ˜ï¼Œåªæ˜¯ä¸€å€‹æ•¸å­—ï¼Œé¦–å…ˆæˆ‘å€‘è¦å…ˆçŸ¥é“æˆæœ¬æ˜¯ä¸€å€‹æ¦‚å¿µï¼Œé‡é»æˆ‘å€‘æ˜¯è¦çœ‹å“ªç¨®æˆæœ¬?</p>
<blockquote>
<p>åƒæˆæœ¬æœ‰åˆ† æ™‚é–“æˆæœ¬ï¼Œé‡‘éŒ¢æˆæœ¬â€¦..éƒ½æ˜¯ä¸åŒç¶­åº¦çš„æˆæœ¬</p>
</blockquote>
<p>æˆ‘å€‘çš„åšæ³•æœƒæŠŠæˆæœ¬æ ¡æº–æˆ <strong>æ™‚é–“æˆæœ¬</strong> ä¹Ÿå°±æ˜¯å¯¦éš›åŸ·è¡Œæ™‚é–“å’Œé ä¼°åŸ·è¡Œæˆæœ¬æ ¡æº–</p>
<h2 id="èª¿æ•™æˆæœ¬å› å­å‰ç½®ä½œæ¥­"><a href="#èª¿æ•™æˆæœ¬å› å­å‰ç½®ä½œæ¥­" class="headerlink" title="èª¿æ•™æˆæœ¬å› å­å‰ç½®ä½œæ¥­"></a>èª¿æ•™æˆæœ¬å› å­å‰ç½®ä½œæ¥­</h2><h3 id="ä¸‹è¼‰-systemtap"><a href="#ä¸‹è¼‰-systemtap" class="headerlink" title="ä¸‹è¼‰ systemtap"></a>ä¸‹è¼‰ systemtap</h3><p>æˆ‘æ˜¯åœ¨ AWS EC2 å»ºç«‹ä¸€å€‹ ubuntu Linux serverï¼æ‰€ä»¥ç›®å‰æˆ‘æ“ä½œæ­¥é©Ÿæ˜¯é‡å°ã€€ubuntu Linux èªªæ˜</p>
<p><a href="https://en.wikipedia.org/wiki/SystemTap">systemtap</a> é€™å€‹å·¥å…·å¯ä»¥ç›£æ¸¬ Linux æ ¸å¿ƒåº•å±¤ æœ¬æ¬¡æˆ‘æœƒè—‰ç”±ä»–ä¾†å¹«æˆ‘å€‘äº†è§£å¯¦éš›æŸ¥è©¢å¹³å‡ IO è®€å–æ™‚é–“</p>
<p>é€é uname å‘½ä»¤æŸ¥çœ‹ kernel ç‰ˆæœ¬</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root:# <span class="built_in">uname</span> -r</span><br><span class="line">5.4.0-1045-aws</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ä¸‹è¼‰ systemtap éœ€è¦ç‰¹åˆ¥æ³¨æ„ä½¿ç”¨ Linux kernel ç‰ˆæœ¬é‚„æœ‰å¹³å°<br>å› ç‚º systemtap dbgsym å°æ–¼ kernel ç‰ˆæœ¬éœ€è¦å°æ‡‰ä¸€è‡´ï¼Œåƒæˆ‘æ©Ÿå™¨ç‰ˆæœ¬æ˜¯ <code>5.4.0-1045-aws</code> æ‰€ä»¥æœƒéœ€è¦ä¸‹è¼‰ <code>5.4.0-1045-aws</code> ç‰ˆæœ¬</p>
</blockquote>
<p>æˆ‘å€‘éœ€è¦åœ¨ update list æ–°å¢å«æœ‰ dbgsym ä¸‹è¼‰è·¯å¾‘ï¼Œæ‰€ä»¥å¯ä»¥è·‘ä¸‹é¢èªæ³•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">codename=$(lsb_release -c | awk  <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">sudo</span> <span class="built_in">tee</span> /etc/apt/sources.list.d/ddebs.list &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">  deb http://ddebs.ubuntu.com/ $&#123;codename&#125;      main restricted universe multiverse</span></span><br><span class="line"><span class="string">  deb http://ddebs.ubuntu.com/ $&#123;codename&#125;-security main restricted universe multiverse</span></span><br><span class="line"><span class="string">  deb http://ddebs.ubuntu.com/ $&#123;codename&#125;-updates  main restricted universe multiverse</span></span><br><span class="line"><span class="string">  deb http://ddebs.ubuntu.com/ $&#123;codename&#125;-proposed main restricted universe multiverse</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"><span class="built_in">sudo</span> apt-get update</span><br><span class="line"><span class="built_in">sudo</span> apt-get install systemtap -y</span><br><span class="line"><span class="built_in">sudo</span> apt-get install gcc -y</span><br><span class="line"><span class="built_in">sudo</span> apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C8CAB6595FDFF622</span><br><span class="line"><span class="built_in">sudo</span> apt-get install linux-image-$(<span class="built_in">uname</span> -r)-dbgsym -y</span><br><span class="line"><span class="built_in">sudo</span> apt-get install linux-headers-$(<span class="built_in">uname</span> -r) -y</span><br></pre></td></tr></table></figure>

<p>å¦‚æœä¸‹è¼‰å®Œç•¢æœƒé¡¯ç¤ºä¸‹è¼‰å®Œç•¢çš„è³‡è¨Šå¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root/pg_log# <span class="built_in">sudo</span> apt-get install linux-image-$(<span class="built_in">uname</span> -r)-dbgsym -y</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">linux-image-5.4.0-1045-aws-dbgsym is already the newest version (5.4.0-1045.47).</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 64 not upgraded.</span><br><span class="line">root/pg_log# <span class="built_in">sudo</span> apt-get install linux-headers-$(<span class="built_in">uname</span> -r) -y</span><br><span class="line">Reading package lists... Done</span><br><span class="line">Building dependency tree       </span><br><span class="line">Reading state information... Done</span><br><span class="line">linux-headers-5.4.0-1045-aws is already the newest version (5.4.0-1045.47).</span><br><span class="line">0 upgraded, 0 newly installed, 0 to remove and 64 not upgraded.</span><br></pre></td></tr></table></figure>

<p>å®‰è£å®Œå¾Œä½¿ç”¨ <code>stap</code> æ‡‰è©²å¯ä»¥çœ‹åˆ°é¡ä¼¼ä¸‹é¢æç¤º</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root:/pg_log# stap</span><br><span class="line">A script must be specified.</span><br><span class="line">Try <span class="string">&#x27;-i&#x27;</span> <span class="keyword">for</span> building a script interactively.</span><br><span class="line">Try <span class="string">&#x27;--help&#x27;</span> <span class="keyword">for</span> more information.</span><br></pre></td></tr></table></figure>

<h2 id="èª¿æ•™æˆæœ¬å› å­"><a href="#èª¿æ•™æˆæœ¬å› å­" class="headerlink" title="èª¿æ•™æˆæœ¬å› å­"></a>èª¿æ•™æˆæœ¬å› å­</h2><p>é¦–å…ˆæˆ‘å€‘è¦å…ˆçŸ¥é“æˆæœ¬æ˜¯ä¸€å€‹æ¦‚å¿µï¼Œé‡é»æˆ‘å€‘æ˜¯è¦çœ‹å“ªç¨®æˆæœ¬?</p>
<blockquote>
<p>åƒæˆæœ¬æœ‰åˆ† æ™‚é–“æˆæœ¬ï¼Œé‡‘éŒ¢æˆæœ¬â€¦..éƒ½æ˜¯ä¸åŒç¶­åº¦çš„æˆæœ¬</p>
</blockquote>
<p>æˆ‘å€‘çš„åšæ³•æœƒæŠŠæˆæœ¬æ ¡æº–æˆ <strong>æ™‚é–“æˆæœ¬</strong> ä¹Ÿå°±æ˜¯å¯¦éš›åŸ·è¡Œæ™‚é–“å’Œé ä¼°åŸ·è¡Œæˆæœ¬æ ¡æº–</p>
<p>åœ¨åŸ·è¡Œè¨ˆç•«ä¸­ QO æœƒåˆ©ç”¨ æˆæœ¬ (cost) ä¾†åˆ¤æ–·ä½¿ç”¨å“ªå€‹åŸ·è¡Œè¨ˆç•«ï¼Œè€Œæˆæœ¬ (cost)æ˜¯é€éå…¬å¼ä¾†è¨ˆç®—å‡ºä¾† <a href="https://github.com/postgres/postgres/blob/master/src/backend/optimizer/path/costsize.c">costsize.c</a></p>
<p>åœ¨å…¬å¼ä¸­æœ‰å¹¾å€‹è®Šæ•¸å¯ä»¥è®“æˆ‘å€‘ä¾†èª¿æ•´<strong>åŸ·è¡Œè¨ˆç•«æˆæœ¬ä¼°ç®—</strong>ï¼Œå°±æ˜¯æ‰€è¬‚çš„æˆæœ¬å› å­</p>
<p>postgreSQL é è¨­çµ¦çš„æˆæœ¬å› å­ä¸¦ä¸èƒ½ç¬¦åˆæ‰€æœ‰æ©Ÿå™¨ç®—æ³•ï¼ä¸åŒçš„ç¡¬é«”ç’°å¢ƒCPUæ€§èƒ½ï¼ŒIOæ€§èƒ½å„ä¸ç›¸åŒï¼Œé è¨­çš„æˆæœ¬å› å­å¯èƒ½ä¸é©åˆç•¶å‰ç¡¬é«”.</p>
<blockquote>
<p>EX: åŒæ¨£ç¡¬é«”è¨­å‚™ï¼Œä½† CPU 2 core å’Œ 32 core è·‘èµ·ä¾†æŸ¥è©¢æ™‚é–“å°±æœƒæœ‰å·®ç•°<br>æˆ‘å€‘åœ¨ <code>SET ENABLE_SEQSACN = OFF;</code> åœ¨è¨ˆç®—æˆæœ¬æ™‚ SEQSACN èµ·å§‹æˆæœ¬æœƒæ˜¯ <code>1.0e10</code></p>
</blockquote>
<p>æœ¬æ¬¡æˆ‘å€‘è¦èª¿æ•™çš„æˆæœ¬å› å­æœ‰ä¸‹é¢äº”å€‹ï¼Œé—œæ–¼æ¯å€‹æˆæœ¬çš„æ„æ¶µæˆ‘éƒ½æœ‰èªªæ˜</p>
<ul>
<li>seq_page_cost : 1 â€“ Table Scan æ¯å€‹ Block æˆæœ¬å› å­</li>
<li>random_page_cost : 4   â€“ Index Scan Block æˆæœ¬å› å­</li>
<li>cpu_tuple_cost : 0.01   â€“ CPU è™•ç†æ¯å€‹ tuple æˆæœ¬å› å­</li>
<li>cpu_index_tuple_cost : 0.005   â€“ Index scan tuple æˆæœ¬å› å­</li>
<li>cpu_operator_cost : 0.0025   â€“ æ“ä½œç¬¦æˆ–å‡½æ•°æˆæœ¬å› å­</li>
</ul>
<p>ä¸‹é¢é€™å¼µè¡¨æ˜¯èª¿æ•™æˆæœ¬å› å­ sample data</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create table</span> tbl (id <span class="type">int</span>,val <span class="type">int</span>, info text, create_time <span class="type">timestamp</span>);  </span><br><span class="line"><span class="keyword">create</span> index ix_tbl <span class="keyword">on</span> tbl (id);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert into</span> tbl </span><br><span class="line"><span class="keyword">select</span> (random()<span class="operator">*</span><span class="number">2000000000</span>)::<span class="type">int</span>, (random()<span class="operator">*</span><span class="number">2000000000</span>)::<span class="type">int</span>,md5(random()::text),  clock_timestamp() <span class="keyword">from</span> generate_series(<span class="number">1</span>,<span class="number">15000000</span>);  </span><br><span class="line">analyze tbl;  </span><br><span class="line">vacuum  tbl;</span><br></pre></td></tr></table></figure>

<h3 id="æˆæœ¬å› å­èªªæ˜"><a href="#æˆæœ¬å› å­èªªæ˜" class="headerlink" title="æˆæœ¬å› å­èªªæ˜"></a>æˆæœ¬å› å­èªªæ˜</h3><p>æ ¡æº–æ–¹æ³•æˆ‘å€‘åˆ©ç”¨ä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼ + åŸºæº–é»æ ¡æº–æ¯å€‹å› å­</p>
<p>seq_page_costå’Œcpu_tuple_costçš„æ ¡æº–<br>seq_page_costé€šéstapæ¸¬è©¦å¾—åˆ°.<br>cpu_tuple_costé€šéå…¬å¼å¾—åˆ°.</p>
<h3 id="ä½¿ç”¨-stap-ç›£è½-process"><a href="#ä½¿ç”¨-stap-ç›£è½-process" class="headerlink" title="ä½¿ç”¨ stap ç›£è½ process"></a>ä½¿ç”¨ stap ç›£è½ process</h3><p>æˆ‘å€‘å¾Œé¢å°±å¯ä»¥åˆ©ç”¨ <code>stap</code> ä¾†ç›£è½æˆ‘å€‘ postgreSQL Client é€£æ¥çš„ porcessï¼Œé€™é‚Šæœ‰å…©å€‹åƒæ•¸æˆ‘å€‘éœ€è¦æ›¿æ›</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">stap -e <span class="string">&#x27; </span></span><br><span class="line"><span class="string">global a  </span></span><br><span class="line"><span class="string">probe process(&quot;&#123;&#123;postgreSQL Bin Path&#125;&#125;&quot;).mark(&quot;query__start&quot;) &#123;  </span></span><br><span class="line"><span class="string">  delete a  </span></span><br><span class="line"><span class="string">  println(&quot;query__start &quot;, user_string($arg1), &quot;pid:&quot;, pid())  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string">probe vfs.read.return &#123;  </span></span><br><span class="line"><span class="string">  t = gettimeofday_ns() - @entry(gettimeofday_ns())  </span></span><br><span class="line"><span class="string">  # if (execname() == &quot;postgres&quot; &amp;&amp; devname != &quot;N/A&quot;)  </span></span><br><span class="line"><span class="string">    a[pid()] &lt;&lt;&lt; t  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string">probe process(&quot;&#123;&#123;postgreSQL Bin Path&#125;&#125;&quot;).mark(&quot;query__done&quot;) &#123;  </span></span><br><span class="line"><span class="string">  if (@count(a[pid()]))   </span></span><br><span class="line"><span class="string">    printdln(&quot;**&quot;, pid(), @count(a[pid()]), @avg(a[pid()]))  </span></span><br><span class="line"><span class="string">  println(&quot;query__done &quot;, user_string($arg1), &quot;pid:&quot;, pid())  </span></span><br><span class="line"><span class="string">  if (@count(a[pid()])) &#123;  </span></span><br><span class="line"><span class="string">    println(@hist_log(a[pid()]))  </span></span><br><span class="line"><span class="string">    #println(@hist_linear(a[pid()],1024,4096,100))  </span></span><br><span class="line"><span class="string">  &#125;  </span></span><br><span class="line"><span class="string">  delete a  </span></span><br><span class="line"><span class="string">&#125;&#x27;</span> -x &#123;&#123;postgreSQL pid&#125;&#125; -v</span><br></pre></td></tr></table></figure>

<ul>
<li>postgreSQL Bin Pathï¼šåˆ©ç”¨æ­¤æŒ‡ä»¤ <code>ps auxw |  grep postgres | grep -- -</code> æŸ¥çœ‹ postgres DB process å•Ÿå‹•è·¯å¾‘ &amp; postgres.conf ä½ç½®</li>
<li>postgreSQL pidï¼š é€é <code>select pg_backend_pid();</code> å¯ä»¥æŸ¥è©¢åˆ°è³‡è¨Š</li>
</ul>
<p>é€é <code>ps auxw |  grep postgres | grep -- -</code> å‘½ä»¤å¯ä»¥æŸ¥æ‰¾åˆ° <code>/usr/lib/postgresql/14/bin/postgres</code> åŸ·è¡Œç¨‹å¼è·¯å¾‘</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@:/pg_log# ps auxw |  grep postgres | grep -- -</span><br><span class="line">postgres   57842  0.0  1.8 219248 18332 ?        Ss   12:55   0:00 /usr/lib/postgresql/14/bin/postgres -D /var/lib/postgresql/14/main -c config_file=/etc/postgresql/14/main/postgresql.conf</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># <span class="keyword">select</span> pg_backend_pid();</span><br><span class="line">pg_backend_pid </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">        <span class="number">57865</span></span><br><span class="line">(<span class="number">1</span> <span class="type">row</span>)</span><br></pre></td></tr></table></figure>

<p>ä¾ç…§ä¸Šé¢åƒæ•¸æˆ‘å€‘æ›¿æ›å¾Œçš„æ¨£æ¿è®Šæˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">stap -e <span class="string">&#x27; </span></span><br><span class="line"><span class="string">global a  </span></span><br><span class="line"><span class="string">probe process(&quot;/usr/lib/postgresql/14/bin/postgres&quot;).mark(&quot;query__start&quot;) &#123;  </span></span><br><span class="line"><span class="string">  delete a  </span></span><br><span class="line"><span class="string">  println(&quot;query__start &quot;, user_string($arg1), &quot;pid:&quot;, pid())  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string">probe vfs.read.return &#123;  </span></span><br><span class="line"><span class="string">  t = gettimeofday_ns() - @entry(gettimeofday_ns())  </span></span><br><span class="line"><span class="string">  # if (execname() == &quot;postgres&quot; &amp;&amp; devname != &quot;N/A&quot;)  </span></span><br><span class="line"><span class="string">    a[pid()] &lt;&lt;&lt; t  </span></span><br><span class="line"><span class="string">&#125;  </span></span><br><span class="line"><span class="string">probe process(&quot;/usr/lib/postgresql/14/bin/postgres&quot;).mark(&quot;query__done&quot;) &#123;  </span></span><br><span class="line"><span class="string">  if (@count(a[pid()]))   </span></span><br><span class="line"><span class="string">    printdln(&quot;**&quot;, pid(), @count(a[pid()]), @avg(a[pid()]))  </span></span><br><span class="line"><span class="string">  println(&quot;query__done &quot;, user_string($arg1), &quot;pid:&quot;, pid())  </span></span><br><span class="line"><span class="string">  if (@count(a[pid()])) &#123;  </span></span><br><span class="line"><span class="string">    println(@hist_log(a[pid()]))  </span></span><br><span class="line"><span class="string">    #println(@hist_linear(a[pid()],1024,4096,100))  </span></span><br><span class="line"><span class="string">  &#125;  </span></span><br><span class="line"><span class="string">  delete a  </span></span><br><span class="line"><span class="string">&#125;&#x27;</span> -x 57865 -v</span><br></pre></td></tr></table></figure>

<p>æ›¿æ›å®Œç•¢å¾Œæˆ‘å€‘å¯ä»¥å˜—è©¦ä½¿ç”¨ root åŸ·è¡Œä¸Šé¢å‘½ä»¤ï¼ŒåŸ·è¡ŒæˆåŠŸæ‡‰è©²æœƒå‡ºç¾é¡ä¼¼ä¸‹é¢è¨Šæ¯ï¼Œä»£è¡¨æˆ‘å€‘å·²ç¶“æˆåŠŸç›£è½äº†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Pass 1: parsed user script and 476 library scripts using 103952virt/90464res/7496shr/82980data kb, <span class="keyword">in</span> 240usr/60sys/485real ms.</span><br><span class="line">Pass 2: analyzed script: 4 probes, 11 <span class="built_in">functions</span>, 9 embeds, 19 globals using 346192virt/331912res/6960shr/325220data kb, <span class="keyword">in</span> 2510usr/730sys/8867real ms.</span><br><span class="line">Pass 3: using cached /root/.systemtap/cache/66/stap_66dcbdbebf362f424bfd78405d2e262b_16109.c</span><br><span class="line">Pass 4: using cached /root/.systemtap/cache/66/stap_66dcbdbebf362f424bfd78405d2e262b_16109.ko</span><br><span class="line">Pass 5: starting run.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¾Œé¢æœƒéœ€è¦é‡è¤‡å¹¾æ¬¡ä¸Šé¢æ“ä½œï¼Œç‚ºäº†æ€•ç¯‡å¹…å¤ªé•·æˆ‘åªæœƒè²¼ä¸Šæ›¿æ›å¾Œçš„æ¨£ç‰ˆ</p>
</blockquote>
<h3 id="æ ¡æº–-seq-page-cost-cpu-tuple-cost"><a href="#æ ¡æº–-seq-page-cost-cpu-tuple-cost" class="headerlink" title="æ ¡æº– seq_page_cost &amp;&amp; cpu_tuple_cost"></a>æ ¡æº– seq_page_cost &amp;&amp; cpu_tuple_cost</h3><p>å› ç‚ºä¸Šé¢æœ‰èªªæˆ‘å€‘è¦æ ¡æº–<strong>æ™‚é–“æˆæœ¬</strong></p>
<p>å…¬å¼ï¼š<code>å¯¦éš›åŸ·è¡Œæ™‚é–“ = (search blocks from disk) * (seq_page_cost) + (search rows) * (cpu_tuple_cost)</code></p>
<p>seq_page_cost &#x3D; stap ç›£è½å¹³å‡åŸ·è¡Œ IO ä¾†ç•¶ä½œæˆæœ¬å› å­ï¼Œæ‰€ä»¥å¾—åˆ°ã€€seq_page_cost å¾Œæˆ‘å€‘å°±å¯ä»¥æ±‚å‡º <code>cpu_tuple_cost</code>.</p>
<blockquote>
<p><code>å¯¦éš›åŸ·è¡Œæ™‚é–“</code>ã€<code>search blocks from disk</code>ã€<code>search rows</code> éƒ½å¯ä»¥é€éåŸ·è¡Œè¨ˆç•«å–å¾—ï¼Œæ‰€ä»¥ä¸Šé¢å…¬å¼è®Šæˆä¸€å…ƒä¸€æ¬¡æ–¹ç¨‹å¼</p>
</blockquote>
<p>åœ¨ä¸€å€‹è¦–çª—é–‹å•Ÿ stap å¾Œï¼Œæˆ‘å€‘å°±å¯ä»¥é€²è¡ŒæŸ¥è©¢ä¸‹é¢èªæ³•å–å¾—åŸ·è¡Œè¨ˆç•«ï¼Œæœƒç™¼ç¾ cost è·Ÿå¯¦éš›åŸ·è¡Œæ™‚é–“å·®ç•°å¾ˆå¤§ï¼ˆæ²’é—œä¿‚æˆ‘å€‘è¦èª¿æ•™ï¼‰</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span>#  explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl; </span><br><span class="line">                                                         QUERY PLAN                                                         </span><br><span class="line"><span class="comment">----------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Seq Scan <span class="keyword">on</span> public.tbl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.304640</span><span class="number">.80</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">15000080</span> width<span class="operator">=</span><span class="number">49</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.736</span>.<span class="number">.14004</span><span class="number">.456</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">15000000</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">   Output: id, val, info, create_time</span><br><span class="line">   Buffers: shared read<span class="operator">=</span><span class="number">154640</span></span><br><span class="line"> Query Identifier: <span class="number">-2758408114362091780</span></span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">65</span> read<span class="operator">=</span><span class="number">16</span></span><br><span class="line"> Planning <span class="type">Time</span>: <span class="number">8.525</span> ms</span><br><span class="line"> Execution <span class="type">Time</span>: <span class="number">26056.658</span> ms</span><br><span class="line">(<span class="number">8</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>

<p>å¾Œé¢åœ¨ stap é‚£å€‹è¦–çª—æœƒå‡ºç¾ä¸‹é¢è³‡è¨Š</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">query__start explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> * from tbl;pid:58916</span><br><span class="line">58916**154665**6662</span><br><span class="line">query__done explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> * from tbl;pid:58916</span><br><span class="line">   value |-------------------------------------------------- count</span><br><span class="line">     256 |                                                       0</span><br><span class="line">     512 |                                                       0</span><br><span class="line">    1024 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  80687</span><br><span class="line">    2048 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@            63125</span><br><span class="line">    4096 |                                                     498</span><br><span class="line">    8192 |                                                     643</span><br><span class="line">   16384 |                                                      20</span><br><span class="line">   32768 |@@@@@                                               8767</span><br><span class="line">   65536 |                                                     832</span><br><span class="line">  131072 |                                                       6</span><br><span class="line">  262144 |                                                      18</span><br><span class="line">  524288 |                                                       8</span><br><span class="line"> 1048576 |                                                       2</span><br><span class="line"> 2097152 |                                                      57</span><br><span class="line"> 4194304 |                                                       2</span><br><span class="line"> 8388608 |                                                       0</span><br><span class="line">16777216 |                                                       0</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†åŸ·è¡Œè¨ˆç•«è·Ÿå¹³å‡åŸ·è¡Œ IO å°±å¯ä»¥å¥—å…¥æˆ‘å€‘çš„å…¬å¼äº†</p>
<blockquote>
<p>6662 æ˜¯å¥ˆç§’ï¼ˆnsï¼‰æˆ‘å€‘éœ€è¦è½‰æ›æˆæ¯«ç§’ï¼ˆmsï¼‰</p>
</blockquote>
<p>å…¬å¼ï¼š<code>å¯¦éš›åŸ·è¡Œæ™‚é–“ = (search blocks from disk) * (seq_page_cost) + (search rows) * (cpu_tuple_cost)</code></p>
<ul>
<li>search blocks from diskï¼š154640</li>
<li>seq_page_cost:6662 ns &#x3D; 0.006662 ms</li>
<li>search rows:15000000</li>
<li>å¯¦éš›åŸ·è¡Œæ™‚é–“ : 14004.456 - 0.736 &#x3D; 14003.72</li>
<li>cpu_tuple_cost &#x3D; 0.0008649005546666667</li>
</ul>
<p><code>14003.72= 154640 * 0.006662 + 15000000 * cpu_tuple_cost</code></p>
<p>æ‰€ä»¥æˆ‘å€‘å¯ä»¥å¾—åˆ°</p>
<ul>
<li>cpu_tuple_cost &#x3D; 0.0008649005546666667;</li>
<li>seq_page_cost &#x3D; 0.006662;</li>
</ul>
<p>æ¯æ¬¡åŸ·è¡Œå®Œç‚ºäº†ç²¾æº–åº¦ï¼Œæˆ‘å€‘éœ€è¦æ¸…é™¤cacheä¸¦é‡æ–°å•Ÿå‹• postgreSQL æ¸…é™¤ shared buffer è³‡æ–™ï¼Œè®“æ¯æ¬¡è³‡æ–™éƒ½å¯ä»¥å¾ disk æ’ˆå–ï¼Œæ‰€ä»¥éƒ½æœƒåŸ·è¡Œä¸‹é¢å…©å€‹èªæ³•</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root:/pg_log# <span class="built_in">sync</span>; <span class="built_in">echo</span> 3 &gt; /proc/sys/vm/drop_caches</span><br><span class="line">root:/pg_log# service postgresql restart</span><br></pre></td></tr></table></figure>

<p>æ¸…é™¤ cache &amp; postgresql restart å¾Œæˆ‘å€‘åˆ©ç”¨æ ¡æº–å¾Œçš„å› å­ä¾†æŸ¥è©¢æ˜¯å¦æœ‰æ•ˆ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">postgres=# SET cpu_tuple_cost = 0.0008649005546666667;</span><br><span class="line">SET</span><br><span class="line">postgres=# SET seq_page_cost = 0.006662;</span><br><span class="line">SET</span><br><span class="line">postgres=#  explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> * from tbl; </span><br><span class="line">                                                        QUERY PLAN                                                         </span><br><span class="line">---------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Seq Scan on public.tbl  (cost=0.00..14003.79 rows=15000080 width=49) (actual <span class="keyword">time</span>=0.905..10640.263 rows=15000000 loops=1)</span><br><span class="line">   Output: <span class="built_in">id</span>, val, info, create_time</span><br><span class="line">   Buffers: shared <span class="built_in">read</span>=154640</span><br><span class="line"> Query Identifier: -2758408114362091780</span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit=65 <span class="built_in">read</span>=16</span><br><span class="line"> Planning Time: 11.077 ms</span><br><span class="line"> Execution Time: 19876.149 ms</span><br><span class="line">(8 rows)</span><br></pre></td></tr></table></figure>

<p>èƒ½çœ‹åˆ°é ä¼°æ™‚é–“æˆæœ¬è·Ÿå¯¦éš›æ™‚é–“æˆæœ¬å·²ç¶“å¾ˆæ¥è¿‘äº†</p>
<blockquote>
<p>å› ç‚ºä½¿ç”¨ stap æœƒæœ‰ä¸€äº›æ™‚é–“æ¶ˆè€—ï¼Œå¯ä»¥å¤šå–å¹¾æ¬¡æ‰¾åˆ°å¹³å‡å€¼é€™è£¡å°±ä¸å¤šèªªäº†</p>
</blockquote>
<h3 id="å–å¾—-random-page-cost-ä»¥åŠ-cpu-index-tuple-cost-cpu-operator-cost"><a href="#å–å¾—-random-page-cost-ä»¥åŠ-cpu-index-tuple-cost-cpu-operator-cost" class="headerlink" title="å–å¾— random_page_cost ä»¥åŠ cpu_index_tuple_cost , cpu_operator_cost"></a>å–å¾— random_page_cost ä»¥åŠ cpu_index_tuple_cost , cpu_operator_cost</h3><p>å‰é¢æˆ‘å€‘èª¿æ•™å…©å€‹æˆæœ¬å› å­ï¼Œæ¥ä¸‹ä¾†è¦æ¥çºŒè¨ˆç®—ã€€random_page_cost ä»¥åŠ cpu_index_tuple_cost , cpu_operator_cost</p>
<ul>
<li>cpu_tuple_cost &#x3D; 0.0008649005546666667;</li>
<li>seq_page_cost &#x3D; 0.006662;</li>
</ul>
<p>æœ¬æ¬¡è¦åˆ©ç”¨ Index Scan å…¬å¼é‚„è¨ˆç®—å‰©ä¸‹å› å­</p>
<p><code>æœ€çµ‚åŸ·è¡Œæ™‚é–“æˆæœ¬ = (search index block) * random_page_cost + cpu_tuple_cost * (tuple search row) + cpu_index_tuple_cost * (tuple search row) + cpu_operator_cost * x</code></p>
<p>æˆ‘å€‘åˆ©ç”¨è¨­å®šæŠŠè®“åŸ·è¡Œè¨ˆç•«æŸ¥è©¢ force æˆ Index Scanï¼Œåˆ©ç”¨å¾—åˆ° stap &amp; åŸ·è¡Œè¨ˆç•«è³‡æ–™é€²è¡Œå„ªåŒ–</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> random_page_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"><span class="keyword">set</span> cpu_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">set</span> cpu_index_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br></pre></td></tr></table></figure>

<p>psql åŸ·è¡Œå¦‚ä¸‹</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># <span class="keyword">select</span> pg_backend_pid();</span><br><span class="line"> pg_backend_pid </span><br><span class="line"><span class="comment">----------------</span></span><br><span class="line">          <span class="number">63285</span></span><br><span class="line">(<span class="number">1</span> <span class="type">row</span>)</span><br><span class="line"></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> random_page_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_index_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># </span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">                                                            QUERY PLAN                                                             </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Index Scan <span class="keyword">using</span> ix_tbl <span class="keyword">on</span> public.tbl  (cost<span class="operator">=</span><span class="number">174.00</span>.<span class="number">.34131</span><span class="number">.99</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8539</span> width<span class="operator">=</span><span class="number">49</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">1.305</span>.<span class="number">.3948</span><span class="number">.019</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">9406</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">   Output: id, val, info, create_time</span><br><span class="line">   Index Cond: (tbl.id <span class="operator">&gt;</span> <span class="number">1998760000</span>)</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">286</span> read<span class="operator">=</span><span class="number">9161</span></span><br><span class="line"> Query Identifier: <span class="number">-1014555039272331675</span></span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">69</span> read<span class="operator">=</span><span class="number">28</span></span><br><span class="line"> Planning <span class="type">Time</span>: <span class="number">13.757</span> ms</span><br><span class="line"> Execution <span class="type">Time</span>: <span class="number">3961.950</span> ms</span><br><span class="line">(<span class="number">9</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>

<p>stap çµæœå¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Pass 4: using cached /root/.systemtap/cache/66/stap_66dcbdbebf362f424bfd78405d2e262b_16109.ko</span><br><span class="line">Pass 5: starting run.</span><br><span class="line">query__start <span class="built_in">set</span> random_page_cost=1;pid:63285</span><br><span class="line">query__done <span class="built_in">set</span> random_page_cost=1;pid:63285</span><br><span class="line">query__start <span class="built_in">set</span> cpu_tuple_cost=1;pid:63285</span><br><span class="line">query__done <span class="built_in">set</span> cpu_tuple_cost=1;pid:63285</span><br><span class="line">query__start <span class="built_in">set</span> cpu_index_tuple_cost=1;pid:63285</span><br><span class="line">query__done <span class="built_in">set</span> cpu_index_tuple_cost=1;pid:63285</span><br><span class="line">query__start <span class="built_in">set</span> cpu_operator_cost=1;pid:63285</span><br><span class="line">query__done <span class="built_in">set</span> cpu_operator_cost=1;pid:63285</span><br><span class="line">query__start <span class="built_in">set</span> enable_seqscan=off;pid:63285</span><br><span class="line">query__done <span class="built_in">set</span> enable_seqscan=off;pid:63285</span><br><span class="line">query__start <span class="built_in">set</span> enable_bitmapscan=off;pid:63285</span><br><span class="line">query__done <span class="built_in">set</span> enable_bitmapscan=off;pid:63285</span><br><span class="line">query__start explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> * from tbl <span class="built_in">where</span> <span class="built_in">id</span> &gt; 1998760000;pid:63285</span><br><span class="line">63285**9207**420006</span><br><span class="line">query__done explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> * from tbl <span class="built_in">where</span> <span class="built_in">id</span> &gt; 1998760000;pid:63285</span><br><span class="line">   value |-------------------------------------------------- count</span><br><span class="line">    1024 |                                                      0</span><br><span class="line">    2048 |                                                      0</span><br><span class="line">    4096 |                                                      4</span><br><span class="line">    8192 |                                                      0</span><br><span class="line">   16384 |                                                      4</span><br><span class="line">   32768 |                                                      1</span><br><span class="line">   65536 |                                                      0</span><br><span class="line">  131072 |                                                      1</span><br><span class="line">  262144 |@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@  8428</span><br><span class="line">  524288 |@@@@                                                696</span><br><span class="line"> 1048576 |                                                     56</span><br><span class="line"> 2097152 |                                                     10</span><br><span class="line"> 4194304 |                                                      7</span><br><span class="line"> 8388608 |                                                      0</span><br><span class="line">16777216 |                                                      0</span><br></pre></td></tr></table></figure>

<p>å†ä¾†å°±æ˜¯æŠŠè³‡è¨Šå¥—å…¥å…¬å¼ä¸­</p>
<p><code>æœ€çµ‚åŸ·è¡Œæ™‚é–“æˆæœ¬ = (search index block) * random_page_cost + cpu_tuple_cost * (tuple search row) + cpu_index_tuple_cost * (tuple search row) + cpu_operator_cost * x</code></p>
<ul>
<li>æœ€çµ‚åŸ·è¡Œæ™‚é–“æˆæœ¬ &#x3D; 3948.019</li>
<li>cpu_tuple_cost &#x3D; 0.0008649005546666667</li>
<li>tuple search row &#x3D; 9406</li>
<li>åŸ·è¡Œå¹³å‡ IO 420006 ns &#x3D; 0.420006 ms (random_page_cost)</li>
</ul>
<p>å¥—ç”¨é€²å…¬å¼æ™‚æœƒç™¼ç¾é‚„æ˜¯æœ‰è¨±å¤šæœªçŸ¥æ•¸</p>
<p><code>3948.019 = (search index block) * 0.420006  +  0.0008649005546666667 * 9406 + cpu_index_tuple_cost * 9406 + cpu_operator_cost * x</code></p>
<blockquote>
<p>search index block æœ‰å…©ç¨®æ–¹å¼å¯ä»¥æŸ¥çœ‹ç¬¬ä¸€å€‹æ˜¯åˆ©ç”¨ <code>bt_page_items</code> äº†è§£ç¯„åœæŸ¥è©¢æœ‰å¤šå°‘ blockï¼Œå¦ä¸€ç¨®æ˜¯åˆ©ç”¨åŸºæº–é»ä¾†ä¼°ç®—å‡ºæ•¸å€¼ã€€ï¼ˆäºŒå…ƒä¸€æ¬¡è¯ç«‹æ–¹ç¨‹å¼ï¼‰</p>
</blockquote>
<h4 id="å–å¾—-search-index-block"><a href="#å–å¾—-search-index-block" class="headerlink" title="å–å¾— search index block"></a>å–å¾— search index block</h4><p>æˆ‘å€‘å…ˆé€€å‡ºä¾† æ¸…é™¤ cache &amp; restart postgreSQLï¼ŒåŸ·è¡Œä¸‹é¢èªæ³•</p>
<blockquote>
<p>å…¶ä¸­æœ‰ä¸€å€‹åœ°æ–¹ä¸ä¸€æ¨£ <code>set random_page_cost=2;</code> ï¼Œå› ç‚ºæˆ‘å€‘è¦åˆ©ç”¨ã€€ï¼ˆäºŒå…ƒä¸€æ¬¡è¯ç«‹æ–¹ç¨‹å¼ï¼‰ æ±‚å‡ºæˆ‘å€‘çš„æ•¸å€¼</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> random_page_cost<span class="operator">=</span><span class="number">2</span>;   </span><br><span class="line"><span class="keyword">set</span> cpu_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">set</span> cpu_index_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br></pre></td></tr></table></figure>

<p>åˆ©ç”¨ä¸Šé¢æŸ¥è©¢è³‡è¨Šå¦‚ä¸‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">postgres=# <span class="built_in">set</span> random_page_cost=2;   </span><br><span class="line">SET</span><br><span class="line">postgres=# <span class="built_in">set</span> cpu_tuple_cost=1;  </span><br><span class="line">SET</span><br><span class="line">postgres=# <span class="built_in">set</span> cpu_index_tuple_cost=1;  </span><br><span class="line">SET</span><br><span class="line">postgres=# <span class="built_in">set</span> cpu_operator_cost=1;   </span><br><span class="line">SET</span><br><span class="line">postgres=# </span><br><span class="line">postgres=# <span class="built_in">set</span> enable_seqscan=off; <span class="built_in">set</span> enable_bitmapscan=off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> * from tbl <span class="built_in">where</span> <span class="built_in">id</span> &gt; 1998760000;</span><br><span class="line">SET</span><br><span class="line">SET</span><br><span class="line">                                                            QUERY PLAN                                                             </span><br><span class="line">-----------------------------------------------------------------------------------------------------------------------------------</span><br><span class="line"> Index Scan using ix_tbl on public.tbl  (cost=174.00..42472.99 rows=8539 width=49) (actual <span class="keyword">time</span>=1.447..3887.553 rows=9406 loops=1)</span><br><span class="line">   Output: <span class="built_in">id</span>, val, info, create_time</span><br><span class="line">   Index Cond: (tbl.id &gt; 1998760000)</span><br><span class="line">   Buffers: shared hit=286 <span class="built_in">read</span>=9161</span><br><span class="line"> Query Identifier: -1014555039272331675</span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit=72 <span class="built_in">read</span>=28</span><br><span class="line"> Planning Time: 15.066 ms</span><br><span class="line"> Execution Time: 3898.528 ms</span><br><span class="line">(9 rows)</span><br></pre></td></tr></table></figure>

<p>é€™é‚Šå·¦é‚Šçš„æˆæœ¬åˆ©ç”¨ ä¼°ç®—æ™‚é–“ å› ç‚ºä¼°ç®—æ™‚é–“å…¬å¼éƒ½ä¸€æ¨£æ˜¯ä¸Šé¢æˆ‘å¯«çš„é‚£å€‹ é€™æ¬¡å”¯ä¸€æœ‰è®Šå‹•çš„éƒ¨åˆ†åªæœ‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">34131.99 = (search index block) *  1 +  9406 + cpu_index_tuple_cost * 9406 + cpu_operator_cost * x`</span><br><span class="line"></span><br><span class="line">42472.99 = 2 * (search index block) * 1  + 9406 + cpu_index_tuple_cost * 9406 + cpu_operator_cost * x</span><br><span class="line">====================================================================================================================================</span><br><span class="line">42472.99 - 34131.99 = (search index block)</span><br><span class="line"></span><br><span class="line">(search index block) = 8341</span><br></pre></td></tr></table></figure>

<p>é€™æ¨£æˆ‘å€‘å°±å¯ä»¥å–å¾— <code>(search index block)</code> è³‡è¨Šï¼ŒåŒç†æˆ‘å€‘å¯ä»¥åˆ©ç”¨ä¸Šé¢æ‰‹æ³•æ¥è‘—å¾—åˆ°å…¬å¼ä¸­ <code>x</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> random_page_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"><span class="keyword">set</span> cpu_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">set</span> cpu_index_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span><span class="number">2</span>;   </span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br></pre></td></tr></table></figure>

<p>æˆ‘å€‘æŠŠ <code>set cpu_operator_cost=2;</code> å…¶ä»–ä¸€æ¨£è¨­å®šæˆ1ï¼Œä¸‹å»åšæ¯”è¼ƒ</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> random_page_cost<span class="operator">=</span><span class="number">1</span>;   </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_index_tuple_cost<span class="operator">=</span><span class="number">1</span>;  </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span><span class="number">2</span>;   </span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># </span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">                                                            QUERY PLAN                                                             </span><br><span class="line"><span class="comment">-----------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Index Scan <span class="keyword">using</span> ix_tbl <span class="keyword">on</span> public.tbl  (cost<span class="operator">=</span><span class="number">348.00</span>.<span class="number">.42844</span><span class="number">.99</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8539</span> width<span class="operator">=</span><span class="number">49</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">1.158</span>.<span class="number">.3981</span><span class="number">.194</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">9406</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">   Output: id, val, info, create_time</span><br><span class="line">   Index Cond: (tbl.id <span class="operator">&gt;</span> <span class="number">1998760000</span>)</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">286</span> read<span class="operator">=</span><span class="number">9161</span></span><br><span class="line"> Query Identifier: <span class="number">-1014555039272331675</span></span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">72</span> read<span class="operator">=</span><span class="number">28</span></span><br><span class="line"> Planning <span class="type">Time</span>: <span class="number">15.108</span> ms</span><br><span class="line"> Execution <span class="type">Time</span>: <span class="number">3992.758</span> ms</span><br><span class="line">(<span class="number">9</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>

<p>è¨ˆç®—æ­¥é©Ÿè·Ÿä¸Šé¢å·®ä¸å¤šï¼Œæˆ‘å°±ç›´æ¥å¸¶åˆ°æ ¸å¿ƒè¨ˆç®—å…¬å¼</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">42844.99 - 34131.99 = x</span><br><span class="line">x = 8713</span><br></pre></td></tr></table></figure>

<p>è‡ªæ­¤æˆ‘å€‘å°±æŠŠæ‰€æœ‰è³‡è¨Šéƒ½å–å¾—äº†</p>
<h3 id="èª¿æ•™æœ€çµ‚æ•¸å€¼"><a href="#èª¿æ•™æœ€çµ‚æ•¸å€¼" class="headerlink" title="èª¿æ•™æœ€çµ‚æ•¸å€¼"></a>èª¿æ•™æœ€çµ‚æ•¸å€¼</h3><ul>
<li>æœ€çµ‚åŸ·è¡Œæ™‚é–“æˆæœ¬ &#x3D; 3948.019</li>
<li>cpu_tuple_cost &#x3D; 0.0008649005546666667</li>
<li>tuple search row &#x3D; 9406</li>
<li>åŸ·è¡Œå¹³å‡ IO 420006 ns &#x3D; 0.420006 ms (random_page_cost)</li>
<li>x &#x3D; 8713</li>
<li>search index block &#x3D; 8341</li>
</ul>
<p><code>3948.019 = 8341 * 0.420006  +  0.0008649005546666667 * 9406 + cpu_index_tuple_cost * 9406 + cpu_operator_cost * 8713</code></p>
<p>æŠŠæ•¸å€¼å¥—ç”¨åœ¨ä¸Šé¢å…¬å¼ï¼Œæœ‰äººæœƒèªªé‚„æœ‰å…©å€‹è®Šæ•¸æ€éº¼è§£é€™å€‹å…¬å¼?</p>
<p>å› ç‚ºåœ¨å»ºè­°è¨­å®šå€¼ cpu_operator_cost : cpu_index_tuple_cost &#x3D; 1 : 2</p>
<p>æ‰€ä»¥æˆ‘å€‘å¯ä»¥æŠŠå…¬å¼è®Šæˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">3948.019 = 8341 * 0.420006  +  0.0008649005546666667 * 9406 + cpu_index_tuple_cost * 9406 + cpu_index_tuple_cost * 2 * 8713</span><br><span class="line"></span><br><span class="line">436.6136993828054 = 26832 * cpu_index_tuple_cost</span><br><span class="line">cpu_index_tuple_cost = 0.016272126542292986</span><br></pre></td></tr></table></figure>

<h2 id="æœ€çµ‚èª¿æ•™å› å­çµæœ"><a href="#æœ€çµ‚èª¿æ•™å› å­çµæœ" class="headerlink" title="æœ€çµ‚èª¿æ•™å› å­çµæœ"></a>æœ€çµ‚èª¿æ•™å› å­çµæœ</h2><ul>
<li>cpu_index_tuple_cost : 0.016272126542292986</li>
<li>cpu_operator_costï¼š0.03254425308458597</li>
<li>cpu_tuple_cost &#x3D; 0.0008649005546666667</li>
<li>seq_page_cost &#x3D; 0.006662;</li>
<li>random_page_cost &#x3D; 0.420006</li>
</ul>
<p>æœ€å¾Œæˆ‘å€‘å¯ä»¥åˆ©ç”¨èª¿æ•™å®Œçš„å› å­é€²è¡ŒæŸ¥è©¢</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--index scan test</span></span><br><span class="line"><span class="keyword">set</span> cpu_index_tuple_cost <span class="operator">=</span> <span class="number">0.016272126542292986</span>;</span><br><span class="line"><span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span> <span class="number">0.03254425308458597</span>;</span><br><span class="line"><span class="keyword">set</span> cpu_tuple_cost <span class="operator">=</span> <span class="number">0.0008649005546666667</span>;</span><br><span class="line"><span class="keyword">set</span> seq_page_cost <span class="operator">=</span> <span class="number">0.006662</span>;</span><br><span class="line"><span class="keyword">set</span> random_page_cost <span class="operator">=</span> <span class="number">0.420006</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">--table scan tests</span></span><br><span class="line"><span class="keyword">set</span> cpu_index_tuple_cost <span class="operator">=</span> <span class="number">0.016272126542292986</span>;</span><br><span class="line"><span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span> <span class="number">0.03254425308458597</span>;</span><br><span class="line"><span class="keyword">set</span> cpu_tuple_cost <span class="operator">=</span> <span class="number">0.0008649005546666667</span>;</span><br><span class="line"><span class="keyword">set</span> seq_page_cost <span class="operator">=</span> <span class="number">0.006662</span>;</span><br><span class="line"><span class="keyword">set</span> random_page_cost <span class="operator">=</span> <span class="number">0.420006</span>;</span><br><span class="line"></span><br><span class="line">explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl;</span><br></pre></td></tr></table></figure>

<p>ç™¼ç¾é ä¼°æˆæœ¬æ™‚é–“å’Œå¯¦éš›æˆæœ¬æ™‚é–“å·²ç¶“è²¼è¿‘è¨±å¤šäº† (å› ç‚ºåœ¨ä½¿ç”¨ stap æ™‚ cpu æœƒæœ‰é¡å¤–æ¶ˆè€—)ï¼Œæ‰€ä»¥å»ºè­°åœ¨èª¿æ•™æ•ˆèƒ½è¦æ‰¾ä¸€å°åŒè¦æ ¼ä¸”å®Œå…¨æ²’äº‹æƒ…çš„æ©Ÿå™¨ä¾†è™•ç†ä¸ç„¶æ•¸å€¼æœƒæœ‰åå·®</p>
<p>table scan &amp; index scan å·²ç¶“è²¼è¿‘çœŸå¯¦æ™‚é–“å¾ˆå¤šäº†</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">                                                           QUERY PLAN                                                           </span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Index Scan <span class="keyword">using</span> ix_tbl <span class="keyword">on</span> public.tbl  (cost<span class="operator">=</span><span class="number">0.43</span>.<span class="number">.3575</span><span class="number">.13</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8539</span> width<span class="operator">=</span><span class="number">49</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">1.402</span>.<span class="number">.3933</span><span class="number">.451</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">9406</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">   Output: id, val, info, create_time</span><br><span class="line">   Index Cond: (tbl.id <span class="operator">&gt;</span> <span class="number">1998760000</span>)</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">286</span> read<span class="operator">=</span><span class="number">9161</span></span><br><span class="line"> Query Identifier: <span class="number">-1014555039272331675</span></span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">72</span> read<span class="operator">=</span><span class="number">28</span></span><br><span class="line"> Planning <span class="type">Time</span>: <span class="number">14.948</span> ms</span><br><span class="line"> Execution <span class="type">Time</span>: <span class="number">3944.197</span> ms</span><br><span class="line">(<span class="number">9</span> <span class="keyword">rows</span>)</span><br><span class="line"></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_operator_cost<span class="operator">=</span> <span class="number">0.03254425308458597</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> cpu_tuple_cost <span class="operator">=</span> <span class="number">0.0008649005546666667</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> seq_page_cost <span class="operator">=</span> <span class="number">0.006662</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> random_page_cost <span class="operator">=</span> <span class="number">0.420006</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">postgres<span class="operator">=</span># </span><br><span class="line">postgres<span class="operator">=</span># <span class="keyword">set</span> enable_seqscan<span class="operator">=</span>off; <span class="keyword">set</span> enable_bitmapscan<span class="operator">=</span>off; explain (analyze,verbose,costs,buffers,timing) <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> tbl <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">1998760000</span>;</span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line"><span class="keyword">SET</span></span><br><span class="line">                                                           QUERY PLAN                                                           </span><br><span class="line"><span class="comment">--------------------------------------------------------------------------------------------------------------------------------</span></span><br><span class="line"> Index Scan <span class="keyword">using</span> ix_tbl <span class="keyword">on</span> public.tbl  (cost<span class="operator">=</span><span class="number">5.66</span>.<span class="number">.3933</span><span class="number">.16</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">8539</span> width<span class="operator">=</span><span class="number">49</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">1.092</span>.<span class="number">.3360</span><span class="number">.230</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">9406</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">   Output: id, val, info, create_time</span><br><span class="line">   Index Cond: (tbl.id <span class="operator">&gt;</span> <span class="number">1998760000</span>)</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">286</span> read<span class="operator">=</span><span class="number">9161</span></span><br><span class="line"> Query Identifier: <span class="number">-1014555039272331675</span></span><br><span class="line"> Planning:</span><br><span class="line">   Buffers: shared hit<span class="operator">=</span><span class="number">72</span> read<span class="operator">=</span><span class="number">28</span></span><br><span class="line"> Planning <span class="type">Time</span>: <span class="number">15.869</span> ms</span><br><span class="line"> Execution <span class="type">Time</span>: <span class="number">3369.814</span> ms</span><br><span class="line">(<span class="number">9</span> <span class="keyword">rows</span>)</span><br></pre></td></tr></table></figure>

<h2 id="å°çµ"><a href="#å°çµ" class="headerlink" title="å°çµ"></a>å°çµ</h2><p>çµ‚æ–¼å¯«å®Œé€™ç¯‡æ–‡ç« äº†ï¼Œè€—æ™‚è¨±å¤šä¸”ä¾†ä¾†å›å›å¾ˆå¤šæ­¥é©Ÿè¦è™•ç†</p>
<p>å‡å¦‚å°æ–¼ä¸Šé¢èªªçš„è¦ºå¾—å¤ªè¤‡é›œï¼Œå¯ä»¥åƒè€ƒç¶²è·¯ä¸Šåˆ¥äººè¼ƒç‚ºé€šç”¨çš„è¨­å®šå€¼</p>
<p><a href="https://stackoverflow.com/questions/33885986/tuning-relstorage-and-parameters-of-postgresql-on-plone-site">Tuning RelStorage and parameters of PostgreSQL on Plone site</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> cpu_tuple_cost = 0.0030;</span><br><span class="line"><span class="built_in">set</span> cpu_index_tuple_cost = 0.0001;</span><br><span class="line"><span class="built_in">set</span> cpu_operator_cost = 0.0005;</span><br><span class="line"><span class="built_in">set</span> random_page_cost = 1.5;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å»ºè­°å¦‚æœæœ‰èƒ½åŠ›é‚„æ˜¯è‡ªå·± tuningï¼Œå› ç‚ºé€™æ¨£æœƒæ›´æº–ç¢º</p>
</blockquote>
<p>__æ­¤æ–‡ä½œè€…__ï¼šDaniel Shih(çŸ³é ­)<br />__æ­¤æ–‡åœ°å€__ï¼š <a href="https://isdaniel.github.io/postgresql-cost-factor-tuning/">https://isdaniel.github.io/postgresql-cost-factor-tuning/</a> <br />__ç‰ˆæ¬Šè²æ˜__ï¼šæœ¬åšå®¢æ‰€æœ‰æ–‡ç« é™¤ç‰¹åˆ¥è²æ˜å¤–ï¼Œå‡æ¡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/tw/">CC BY-NC-SA 3.0 TW</a> è¨±å¯å”è­°ã€‚è½‰è¼‰è«‹è¨»æ˜å‡ºè™•ï¼</p>

    </div>

    
    
    
      
  <div class="popular-posts-header">Related Posts</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/map-theory/" rel="bookmark">è³‡æ–™åº«æŸ¥è©¢æ ¸å¿ƒæ¦‚å¿µ-åœ°åœ–ç†è«–</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/postgresql-hotupdate-vacuum/" rel="bookmark">postgresql HOT (heap only tuple) update æ·±å…¥æ·ºå‡º</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/postgresql-page-deepknow/" rel="bookmark">postgresql Page æ·±å…¥æ·ºå‡º</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/postgresql-wal-introduce/" rel="bookmark">postgresql WAL (Write-Ahead Logging) æ©Ÿåˆ¶</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/DBIndex-1/" rel="bookmark">è³‡æ–™åº«ç´¢å¼•æ·±å…¥æ·ºå‡º(ä¸€)</a></div>
    </li>
  </ul>
<div style="text-align: center;">
    å¦‚æœæœ¬æ–‡å°æ‚¨å¹«åŠ©å¾ˆå¤§ï¼Œå¯<a href="https://www.jkos.com/">è¡—å£æ”¯ä»˜</a>æ–—å…§é¼“å‹µçŸ³é ­^^
</div>

<img src="https://i.imgur.com/1D2UpQk.png">


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/DataBase/" rel="tag"># DataBase</a>
              <a href="/tags/Turning/" rel="tag"># Turning</a>
              <a href="/tags/postgresql/" rel="tag"># postgresql</a>
              <a href="/tags/cost/" rel="tag"># cost</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/aws-first-lambda/" rel="prev" title="AWS Lambda åˆé«”é©— by .net core">
      <i class="fa fa-chevron-left"></i> AWS Lambda åˆé«”é©— by .net core
    </a></div>
      <div class="post-nav-item">
    <a href="/redlock-deepknow/" rel="next" title="åˆ©ç”¨Redlockæ¼”ç®—æ³•å¯¦ç¾è‡ªå·±çš„åˆ†ä½ˆå¼é–">
      åˆ©ç”¨Redlockæ¼”ç®—æ³•å¯¦ç¾è‡ªå·±çš„åˆ†ä½ˆå¼é– <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">å‰è¨€</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%A0%90%E8%A8%AD%E6%88%90%E6%9C%AC%E5%9B%A0%E5%AD%90%E6%BD%9B%E5%9C%A8%E5%95%8F%E9%A1%8C"><span class="nav-number">2.</span> <span class="nav-text">é è¨­æˆæœ¬å› å­æ½›åœ¨å•é¡Œ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AA%BF%E6%95%99%E6%88%90%E6%9C%AC%E5%9B%A0%E5%AD%90%E5%89%8D%E7%BD%AE%E4%BD%9C%E6%A5%AD"><span class="nav-number">3.</span> <span class="nav-text">èª¿æ•™æˆæœ¬å› å­å‰ç½®ä½œæ¥­</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8B%E8%BC%89-systemtap"><span class="nav-number">3.1.</span> <span class="nav-text">ä¸‹è¼‰ systemtap</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AA%BF%E6%95%99%E6%88%90%E6%9C%AC%E5%9B%A0%E5%AD%90"><span class="nav-number">4.</span> <span class="nav-text">èª¿æ•™æˆæœ¬å› å­</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%88%90%E6%9C%AC%E5%9B%A0%E5%AD%90%E8%AA%AA%E6%98%8E"><span class="nav-number">4.1.</span> <span class="nav-text">æˆæœ¬å› å­èªªæ˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8-stap-%E7%9B%A3%E8%81%BD-process"><span class="nav-number">4.2.</span> <span class="nav-text">ä½¿ç”¨ stap ç›£è½ process</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%A0%A1%E6%BA%96-seq-page-cost-cpu-tuple-cost"><span class="nav-number">4.3.</span> <span class="nav-text">æ ¡æº– seq_page_cost &amp;&amp; cpu_tuple_cost</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%96%E5%BE%97-random-page-cost-%E4%BB%A5%E5%8F%8A-cpu-index-tuple-cost-cpu-operator-cost"><span class="nav-number">4.4.</span> <span class="nav-text">å–å¾— random_page_cost ä»¥åŠ cpu_index_tuple_cost , cpu_operator_cost</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%96%E5%BE%97-search-index-block"><span class="nav-number">4.4.1.</span> <span class="nav-text">å–å¾— search index block</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%AA%BF%E6%95%99%E6%9C%80%E7%B5%82%E6%95%B8%E5%80%BC"><span class="nav-number">4.5.</span> <span class="nav-text">èª¿æ•™æœ€çµ‚æ•¸å€¼</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9C%80%E7%B5%82%E8%AA%BF%E6%95%99%E5%9B%A0%E5%AD%90%E7%B5%90%E6%9E%9C"><span class="nav-number">5.</span> <span class="nav-text">æœ€çµ‚èª¿æ•™å› å­çµæœ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%B5%90"><span class="nav-number">6.</span> <span class="nav-text">å°çµ</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Daniel Shih"
      src="https://avatars0.githubusercontent.com/u/9159452?s=460&v=4">
  <p class="site-author-name" itemprop="name">Daniel Shih</p>
  <div class="site-description" itemprop="description">å¥½é»å­æ²’åƒ¹å€¼ï¼Œæœ‰åƒ¹å€¼çš„æ˜¯æŠŠå¥½é»å­å¯¦ç¾</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">186</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">136</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/isdaniel" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;isdaniel" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:dog8300228@gmail.com" title="Email â†’ mailto:dog8300228@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>Email</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100001400319136" title="FaceBook â†’ https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100001400319136" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i>FaceBook</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/5176071/d-shih" title="StackOverflow â†’ https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;5176071&#x2F;d-shih" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
      </span>
  </div>



<p><a href="https://stackoverflow.com/users/5176071/d-shih"><img alt="profile for D-Shih at Stack Overflow, Q&amp;A for professional and enthusiast programmers" height="58" src="https://stackoverflow.com/users/flair/5176071.png?theme=dark" title="profile for D-Shih at Stack Overflow, Q&amp;A for professional and enthusiast programmers" width="208" /> </a></p>

<div>
<a href="https://info.flagcounter.com/tORe"><img src="https://s01.flagcounter.com/count/tORe/bg_F1FF29/txt_000000/border_9DCCC4/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>
</div>

Certificationsï¼š

<div data-iframe-width="150" data-iframe-height="270" data-share-badge-id="41c9e6a3-2a37-49e1-9a53-37e0bfa9e6e1" data-share-badge-host="https://www.credly.com"></div><script type="text/javascript" async src="//cdn.credly.com/assets/utilities/embed.js"></script>

<amp-auto-ads type="adsense"
        data-ad-client="ca-pub-9964202165342528">
</amp-auto-ads>
      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Shih</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">905k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">13:43</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v7.3.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme â€“ <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri == 'https://isdaniel.github.io/postgresql-cost-factor-tuning/',]
      });
      });
  </script>

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://danielshih.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://isdaniel.github.io/postgresql-cost-factor-tuning/";
    this.page.identifier = "postgresql-cost-factor-tuning/";
    this.page.title = "postgresql åŸ·è¡Œè¨ˆç•«é‡è¦å› å­ (æˆæœ¬å› å­èª¿æ•™)";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://danielshih.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
