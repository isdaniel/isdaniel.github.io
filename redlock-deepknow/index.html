<!DOCTYPE html>
<html lang="zh-tw">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"isdaniel.github.io","root":"/","scheme":"Gemini","version":"7.7.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言我之前有寫透過 lock or CAS 來防治，Racing condition 問題，但如果這個問題延深到多台服務器甚至是 micor-services 架構我們要怎麼處理資料問題呢? 下面程式在單體服務或應用程式不會出問題，但如果服務器有多台問題可就大了，因為下面的 lock 只限於單體 Server 上 1234567891011121314151617181920private rea">
<meta property="og:type" content="article">
<meta property="og:title" content="利用Redlock演算法實現自己的分佈式鎖">
<meta property="og:url" content="https://isdaniel.github.io/redlock-deepknow/index.html">
<meta property="og:site_name" content="石頭的coding之路">
<meta property="og:description" content="前言我之前有寫透過 lock or CAS 來防治，Racing condition 問題，但如果這個問題延深到多台服務器甚至是 micor-services 架構我們要怎麼處理資料問題呢? 下面程式在單體服務或應用程式不會出問題，但如果服務器有多台問題可就大了，因為下面的 lock 只限於單體 Server 上 1234567891011121314151617181920private rea">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://i.imgur.com/nt8Q9Sv.png">
<meta property="og:image" content="https://i.imgur.com/7Zyji6N.png">
<meta property="og:image" content="https://i.imgur.com/nqxIxwD.png">
<meta property="og:image" content="https://i.imgur.com/SGdamvC.png">
<meta property="og:image" content="https://i.imgur.com/3w0cD8l.png">
<meta property="article:published_time" content="2021-10-25T09:30:11.000Z">
<meta property="article:modified_time" content="2025-02-11T08:33:52.874Z">
<meta property="article:author" content="Daniel Shih">
<meta property="article:tag" content="C#">
<meta property="article:tag" content="Redis">
<meta property="article:tag" content="Redlock">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.imgur.com/nt8Q9Sv.png">

<link rel="canonical" href="https://isdaniel.github.io/redlock-deepknow/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true
  };
</script>

  <title>利用Redlock演算法實現自己的分佈式鎖 | 石頭的coding之路</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">石頭的coding之路</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">Hello World</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-course">

    <a href="/Course/" rel="section"><i class="fa fa-fw fa-book"></i>Course</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>Tags<span class="badge">125</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>Categories<span class="badge">54</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives<span class="badge">180</span></a>

  </li>
  </ul>

</nav>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block " lang="zh-tw">
    <link itemprop="mainEntityOfPage" href="https://isdaniel.github.io/redlock-deepknow/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="https://avatars0.githubusercontent.com/u/9159452?s=460&v=4">
      <meta itemprop="name" content="Daniel Shih">
      <meta itemprop="description" content="好點子沒價值，有價值的是把好點子實現">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="石頭的coding之路">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          利用Redlock演算法實現自己的分佈式鎖
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-10-25 09:30:11" itemprop="dateCreated datePublished" datetime="2021-10-25T09:30:11+00:00">2021-10-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2025-02-11 08:33:52" itemprop="dateModified" datetime="2025-02-11T08:33:52+00:00">2025-02-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/" itemprop="url" rel="index"><span itemprop="name">C#</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/C/Redis/" itemprop="url" rel="index"><span itemprop="name">Redis</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="fa fa-comment-o"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/redlock-deepknow/#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="redlock-deepknow/" itemprop="commentCount"></span>
    </a>
  </span>
  
  <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>我之前有寫透過 <a href="https://isdaniel.github.io/high-concurrency-atomic-cas-algorithm/">lock or CAS</a> 來防治，Racing condition 問題，但如果這個問題延深到多台服務器甚至是 micor-services 架構我們要怎麼處理資料問題呢?</p>
<p>下面程式在單體服務或應用程式不會出問題，但如果服務器有多台問題可就大了，因為下面的 lock 只限於單體 Server 上</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">readonly</span> <span class="keyword">static</span> <span class="built_in">object</span> _lock = <span class="keyword">new</span> <span class="built_in">object</span>();</span><br><span class="line">[<span class="meta">HttpGet()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> remainCount;</span><br><span class="line">    <span class="keyword">lock</span> (_lock)</span><br><span class="line">    &#123;</span><br><span class="line">        </span><br><span class="line">        remainCount = (<span class="built_in">int</span>)RedisConnection.GetDatabase().StringGet(_productId);</span><br><span class="line">        <span class="keyword">if</span> (remainCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            RedisConnection.GetDatabase().StringSet(_productId, --remainCount);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">string</span> productMsg = remainCount &lt;= <span class="number">0</span> ? <span class="string">&quot;沒貨了賣完了&quot;</span> : <span class="string">$&quot;還剩下 <span class="subst">&#123;remainCount&#125;</span> 商品&quot;</span>;</span><br><span class="line">    <span class="built_in">string</span> result = <span class="string">$&quot;<span class="subst">&#123;Dns.GetHostName()&#125;</span> 處理貨物狀態!! <span class="subst">&#123;productMsg&#125;</span>&quot;</span>;</span><br><span class="line">    _logger.LogInformation(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果有聽過 Redis 可能就會聽過 <a href="https://github.com/samcook/RedLock.net">RedLock.net</a> 來處理，但您知道 RedLock.net 底層大致上怎麼實作的嗎?</p>
<p>本篇文章會帶領大家透過 distlock 算法時做出，自己的Redlock</p>
<blockquote>
<p>本篇只介紹核心概念，細部防錯我沒有寫出來，所以建議本篇程式不要用在 prod 環境</p>
</blockquote>
<p>我使用 docker-compose 建立問題架構，架構圖如下</p>
<p><img src="https://i.imgur.com/nt8Q9Sv.png"></p>
<p>原始碼位置 <a href="https://github.com/isdaniel/Redlock-Csharp">Redlock-Csharp</a></p>
<h2 id="How-to-Run"><a href="#How-to-Run" class="headerlink" title="How to Run"></a>How to Run</h2><p>在根目錄使用 <code>docker-compose up -d</code> 跑起來後應該會有下面五個組件</p>
<p><img src="https://i.imgur.com/7Zyji6N.png"></p>
<p>後面我們進入 Redis Server 利用命令建立一個商品和數量 <code>set pid:1 1000</code></p>
<blockquote>
<p><code>pid=1</code> 有 1000 個</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ docker <span class="built_in">exec</span> -it b489eb20ab74 bash</span><br><span class="line">root@b489eb20ab74:/data# redis-cli</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> pid:1 1000</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<p>在查詢 <code>http://localhost:8080/WebStore</code> 可以獲得下圖代表組件建立完畢</p>
<p><img src="https://i.imgur.com/nqxIxwD.png"></p>
<h2 id="Redlock-演算法"><a href="#Redlock-演算法" class="headerlink" title="Redlock 演算法"></a>Redlock 演算法</h2><p>其實 <a href="https://redis.io/topics/distlock">distlock</a> 算法說明在 Redis 官網有一篇專門來說明，</p>
<p>測試檔案已經準備好了 <code>/test/shopping.jmx</code>，我們使用 jmeter 來壓測，使用壓力測試程式，建議 Jmeter 使用 Thread 最好小於或等於 cpu core count (最好設定2的倍數)</p>
<p>ex: 我的電腦 8 core 我可以設定 8 thread concurrent</p>
<p>這邊有一個情境假設，有一個商品秒殺只有 200 個商品</p>
<p>這邊我們要怎麼防止賣超呢?</p>
<p>我們把 <code>lock</code> 部分替換成我們自己寫的 <code>RedLock</code> 物件．我有透過 Redis 算法實現一個簡單的分佈式鎖</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">HttpGet()</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">string</span> <span class="title">Get</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    RedLock redlock = <span class="keyword">new</span> RedLock(RedisConnection);</span><br><span class="line">    <span class="built_in">int</span> remainCount;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        redlock.LockInstance(<span class="string">&quot;redkey&quot;</span>, <span class="keyword">new</span> TimeSpan(<span class="number">00</span>, <span class="number">00</span>, <span class="number">10</span>), <span class="keyword">out</span> <span class="keyword">var</span> lockObject);</span><br><span class="line">        remainCount = (<span class="built_in">int</span>)RedisConnection.GetDatabase().StringGet(_productId);</span><br><span class="line">        <span class="keyword">if</span> (remainCount &gt; <span class="number">0</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            RedisConnection.GetDatabase().StringSet(_productId, --remainCount);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        redlock.UnlockInstance(<span class="string">&quot;redkey&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">string</span> productMsg = remainCount &lt;= <span class="number">0</span> ? <span class="string">&quot;沒貨了賣完了&quot;</span> : <span class="string">$&quot;還剩下 <span class="subst">&#123;remainCount&#125;</span> 商品&quot;</span>;</span><br><span class="line">    <span class="built_in">string</span> result = <span class="string">$&quot;<span class="subst">&#123;Dns.GetHostName()&#125;</span> 處理貨物狀態!! <span class="subst">&#123;productMsg&#125;</span>&quot;</span>;</span><br><span class="line">    _logger.LogInformation(result);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>透過 jmeter 壓力測試</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">$ .\jmeter -n -t .\shopping.jmx -l .\shopping.jtl</span><br><span class="line">Creating summariser &lt;summary&gt;</span><br><span class="line">Starting standalone </span><br><span class="line">Waiting <span class="keyword">for</span> possible Shutdown/StopTestNow/HeapDump/ThreadDump message on port 4445</span><br><span class="line">summary +      1 <span class="keyword">in</span> 00:00:01 =    1.0/s Avg:    91 Min:    91 Max:    91 Err:     0 (0.00%) Active: 15 Started: 15 Finished: 0</span><br><span class="line">summary +   1599 <span class="keyword">in</span> 00:00:12 =  137.1/s Avg:    77 Min:     3 Max:  8921 Err:     0 (0.00%) Active: 0 Started: 16 Finished: 16</span><br><span class="line">summary =   1600 <span class="keyword">in</span> 00:00:13 =  126.8/s Avg:    77 Min:     3 Max:  8921 Err:     0 (0.00%)</span><br><span class="line">Tidying up ...    @ Mon Oct 25 11:37:15 CST 2021 (1635133035562)</span><br><span class="line">... end of run</span><br></pre></td></tr></table></figure>

<p>結果如下：</p>
<p>在多台 server 上並沒有出現賣超</p>
<p><img src="https://i.imgur.com/SGdamvC.png"></p>
<h3 id="RedLock-解說程式"><a href="#RedLock-解說程式" class="headerlink" title="RedLock 解說程式"></a>RedLock 解說程式</h3><p>裡面最核心程式是 <code>RedLock</code> 類別．建構子會傳入我們使用 <code>Redis</code> Connection</p>
<p>其中核心方式是</p>
<ul>
<li>LockInstance</li>
<li>UnlockInstance</li>
</ul>
<h4 id="LockInstance"><a href="#LockInstance" class="headerlink" title="LockInstance"></a>LockInstance</h4><p>在 Lock 需要注意 Atomic 並且需要給一個 TTL 不然假如機器突然當機或跳電，會造成鎖不會解放其他人會無限期 blocking</p>
<p>下面這段話是來是官網</p>
<blockquote>
<p>since this is actually a viable solution in applications where a race condition from time to time is acceptable, and because locking into a single instance is the foundation we’ll use for the distributed algorithm described here.</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET resource_name my_random_value NX PX 30000</span><br></pre></td></tr></table></figure>

<blockquote>
<p>NX – Only set the key if it does not already exist.</p>
</blockquote>
<p>Redis 操作命令是一個 single Thread 執行所以命令如果可以包在一包或一條來執行就可以保證 Atomic，<a href="https://redis.io/commands/set">SET</a> <code>NX</code> 命令<strong>不存在</strong> key 建立數值 (具有 Atomic )</p>
<p>另外我為了避免一直在空轉，我會判斷假如目前有人佔有鎖我會自旋等待一個時間( lock TTL )，到了後在嘗試訪問（可以有更優的算法但我懶得寫了）避免浪費資源空轉</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RedLock</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IConnectionMultiplexer _connection;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _keyId;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedLock</span>(<span class="params">IConnectionMultiplexer connection</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _connection = connection;</span><br><span class="line">        _keyId = <span class="string">$&quot;<span class="subst">&#123;Guid.NewGuid().ToString()&#125;</span>-Tid:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">LockInstance</span>(<span class="params"><span class="built_in">string</span> resource, TimeSpan ttl, <span class="keyword">out</span> LockObject lockObject</span>)</span></span><br><span class="line">    &#123;   </span><br><span class="line">        <span class="built_in">bool</span> result;</span><br><span class="line">        lockObject = <span class="keyword">new</span> LockObject(resource, _keyId, ttl);</span><br><span class="line">        <span class="keyword">try</span></span><br><span class="line">        &#123;</span><br><span class="line">        </span><br><span class="line">            <span class="keyword">do</span></span><br><span class="line">            &#123;</span><br><span class="line">            result = _connection.GetDatabase().StringSet(resource, _keyId, ttl, When.NotExists);</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">if</span>(!result)</span><br><span class="line">                    WaitForLock(resource);</span><br><span class="line"></span><br><span class="line">            &#125; <span class="keyword">while</span> (!result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (Exception)</span><br><span class="line">        &#123;</span><br><span class="line">            result = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">WaitForLock</span>(<span class="params"><span class="built_in">string</span> resource</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">var</span> waitTime = _connection.GetDatabase().KeyTimeToLive(resource);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(waitTime.HasValue)&#123;</span><br><span class="line">            SpinWait.SpinUntil(()=&gt;<span class="literal">true</span>,waitTime.Value.Milliseconds);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="UnlockInstance"><a href="#UnlockInstance" class="headerlink" title="UnlockInstance"></a>UnlockInstance</h4><p>我們必須讓 <strong>查詢</strong> 跟 <strong>刪除</strong> keyid 有 Atomic 所以有兩種做法</p>
<ol>
<li>透過 Lua 腳本讓命令連續</li>
<li>使用 Redis transaction 模式</li>
</ol>
<p>本次程式解鎖程式是靠 Lua 腳本來完成( Redis 官網推薦)</p>
<p>下面是官網的說明</p>
<blockquote>
<p>This is important in order to avoid removing a lock that was created by another client. For example a client may acquire the lock, get blocked in some operation for longer than the lock validity time (the time at which the key will expire), and later remove the lock, that was already acquired by some other client. Using just DEL is not safe as a client may remove the lock of another client. With the above script instead every lock is “signed” with a random string, so the lock will be removed only if it is still the one that was set by the client trying to remove it.</p>
</blockquote>
<p>建議在 Keyid 那邊可以標示是由你產生的鎖避免刪除到別人 lock，所以我的程式 keyid 使用 GUID + ThreadId 來保證不會有人跟我產生一樣的 keyId</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">RedLock</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">private</span> IConnectionMultiplexer _connection;</span><br><span class="line">    <span class="keyword">private</span> <span class="built_in">string</span> _keyId;</span><br><span class="line">    <span class="keyword">const</span> <span class="built_in">string</span> UNLOCK_SCRIPT = <span class="string">@&quot;</span></span><br><span class="line"><span class="string">        if redis.call(&quot;&quot;get&quot;&quot;,KEYS[1]) == ARGV[1] then</span></span><br><span class="line"><span class="string">            return redis.call(&quot;&quot;del&quot;&quot;,KEYS[1])</span></span><br><span class="line"><span class="string">        else</span></span><br><span class="line"><span class="string">            return 0</span></span><br><span class="line"><span class="string">        end&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">RedLock</span>(<span class="params">IConnectionMultiplexer connection</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        _connection = connection;</span><br><span class="line">        _keyId = <span class="string">$&quot;<span class="subst">&#123;Guid.NewGuid().ToString()&#125;</span>-Tid:<span class="subst">&#123;Thread.CurrentThread.ManagedThreadId&#125;</span>&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">UnlockInstance</span>(<span class="params"><span class="built_in">string</span> resource</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        RedisKey[] keys = &#123; resource &#125;;</span><br><span class="line">        RedisValue[] values = &#123; _keyId &#125;;</span><br><span class="line">        _connection.GetDatabase().ScriptEvaluate(</span><br><span class="line">            UNLOCK_SCRIPT,</span><br><span class="line">            keys,</span><br><span class="line">            values</span><br><span class="line">            );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://i.imgur.com/3w0cD8l.png"></p>
<h2 id="小結"><a href="#小結" class="headerlink" title="小結"></a>小結</h2><p>本次跟大家介紹 Redlock 算法帶著大家快速走過一遍，能發現實現 lock 算法其實不會很難，這邊留一個地方讓大家考慮一下</p>
<p>之前我有篇文章討論 <a href="https://isdaniel.github.io/lock-deepknow/">c# lock</a> 原理，裡面有討論可重入鎖模式，假如給你實現可重入鎖你會實現嗎？</p>
<p>在實現的過程中你會發現原來 lock 核心是算法而不是實作，實作可以由許多方式來處理但算法概念不會變</p>
<p>本程式不建議在 Prod 上使用，因為我沒有實現多台 master Redis 同步 lock、鎖 TTL 到了 logic 還在執行需要延長等等問題…</p>
<p>__此文作者__：Daniel Shih(石頭)<br />__此文地址__： <a href="https://isdaniel.github.io/redlock-deepknow/">https://isdaniel.github.io/redlock-deepknow/</a> <br />__版權聲明__：本博客所有文章除特別聲明外，均採用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/tw/">CC BY-NC-SA 3.0 TW</a> 許可協議。轉載請註明出處！</p>

    </div>

    
    
    
      
  <div class="popular-posts-header">Related Posts</div>
  <ul class="popular-posts">
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/ACID/" rel="bookmark">ACID</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/AOP-Lock-Mechanism/" rel="bookmark">AOP Lock Architecture</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/AutoMapperInit/" rel="bookmark">(AutoMapper)反射自動註冊AutoMapper Profile</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/Autofac-AOP/" rel="bookmark">Autofac + Interceptors(AOP) 動態代理</a></div>
    </li>
    <li class="popular-posts-item">
      <div class="popular-posts-title"><a href="/Autofac-introduce/" rel="bookmark">Autofac (IOC)容器介紹</a></div>
    </li>
  </ul>
<div style="text-align: center;">
    如果本文對您幫助很大，可<a href="https://www.jkos.com/">街口支付</a>斗內鼓勵石頭^^
</div>

<img src="https://i.imgur.com/1D2UpQk.png">


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/C/" rel="tag"># C#</a>
              <a href="/tags/Redis/" rel="tag"># Redis</a>
              <a href="/tags/Redlock/" rel="tag"># Redlock</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/postgresql-cost-factor-tuning/" rel="prev" title="postgresql 執行計畫重要因子 (成本因子調教)">
      <i class="fa fa-chevron-left"></i> postgresql 執行計畫重要因子 (成本因子調教)
    </a></div>
      <div class="post-nav-item">
    <a href="/map-theory/" rel="next" title="資料庫查詢核心概念-地圖理論">
      資料庫查詢核心概念-地圖理論 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  

  </div>


          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let activeClass = CONFIG.comments.activeClass;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#How-to-Run"><span class="nav-number">2.</span> <span class="nav-text">How to Run</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Redlock-%E6%BC%94%E7%AE%97%E6%B3%95"><span class="nav-number">3.</span> <span class="nav-text">Redlock 演算法</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#RedLock-%E8%A7%A3%E8%AA%AA%E7%A8%8B%E5%BC%8F"><span class="nav-number">3.1.</span> <span class="nav-text">RedLock 解說程式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#LockInstance"><span class="nav-number">3.1.1.</span> <span class="nav-text">LockInstance</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#UnlockInstance"><span class="nav-number">3.1.2.</span> <span class="nav-text">UnlockInstance</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B0%8F%E7%B5%90"><span class="nav-number">4.</span> <span class="nav-text">小結</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Daniel Shih"
      src="https://avatars0.githubusercontent.com/u/9159452?s=460&v=4">
  <p class="site-author-name" itemprop="name">Daniel Shih</p>
  <div class="site-description" itemprop="description">好點子沒價值，有價值的是把好點子實現</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">180</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">54</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">125</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/isdaniel" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;isdaniel" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:dog8300228@gmail.com" title="Email → mailto:dog8300228@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>Email</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100001400319136" title="FaceBook → https:&#x2F;&#x2F;www.facebook.com&#x2F;profile.php?id&#x3D;100001400319136" rel="noopener" target="_blank"><i class="fa fa-fw fa-facebook"></i>FaceBook</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/5176071/d-shih" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;5176071&#x2F;d-shih" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
      </span>
  </div>



<p><a href="https://stackoverflow.com/users/5176071/d-shih"><img alt="profile for D-Shih at Stack Overflow, Q&amp;A for professional and enthusiast programmers" height="58" src="https://stackoverflow.com/users/flair/5176071.png?theme=dark" title="profile for D-Shih at Stack Overflow, Q&amp;A for professional and enthusiast programmers" width="208" /> </a></p>

<div>
<a href="https://info.flagcounter.com/tORe"><img src="https://s01.flagcounter.com/count/tORe/bg_F1FF29/txt_000000/border_9DCCC4/columns_2/maxflags_10/viewers_0/labels_1/pageviews_1/flags_0/percent_0/" alt="Flag Counter" border="0"></a>
</div>

Certifications：

<div data-iframe-width="150" data-iframe-height="270" data-share-badge-id="41c9e6a3-2a37-49e1-9a53-37e0bfa9e6e1" data-share-badge-host="https://www.credly.com"></div><script type="text/javascript" async src="//cdn.credly.com/assets/utilities/embed.js"></script>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Daniel Shih</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="Symbols count total">881k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">13:21</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> v7.3.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">Theme – <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> v7.7.2
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout : 3000,
        priority: true,
        ignores : [uri => uri.includes('#'),uri => uri == 'https://isdaniel.github.io/redlock-deepknow/',]
      });
      });
  </script>

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://danielshih.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://isdaniel.github.io/redlock-deepknow/";
    this.page.identifier = "redlock-deepknow/";
    this.page.title = "利用Redlock演算法實現自己的分佈式鎖";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://danielshih.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
